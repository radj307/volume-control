name: Generate Release

on:
  push:
    tags: '*.*.*'
  workflow_dispatch:
  
jobs:
  build-release:
    runs-on: windows-latest
    env:
      DOTNET_CLI_TELEMETRY_OPTOUT: true

    steps:
    - name: Checkout
      uses: actions/checkout@v2
      with:
        fetch-depth:  0

    - name: Install .NET Core
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 6.0.x
        
    - name: Setup Dotnet
      uses: actions/setup-dotnet@main
      
    - name: Build Solution
      run:  dotnet build
      
    - name: Publish VolumeControl Release to Directory
      run:  dotnet publish VolumeControl -c Release /p:PublishProfile="VolumeControl/Properties/PublishProfiles/FolderProfile.pubxml"
      
    - name: Publish VolumeControlCLI Release to Directory
      run:  dotnet publish VolumeControlCLI -c Release /p:PublishProfile="VolumeControlCLI/Properties/PublishProfiles/FolderProfile.pubxml"
      
    - name:   Stage Files
      run:    |
              mkdir "${{github.workspace}}/STAGING"
              cd "${{github.workspace}}/STAGING"
              foreach($file in $((dir "${{github.workspace}}/publish" -recurse | where {$_.extension -in ".exe",".dll"}).Fullname)){ mv $file ./ }
              Compress-Archive ./* "VolumeControl-${GITHUB_REF/refs\/tags\//}.zip"
              mv "./*.zip" "${{github.workspace}}"
          
    - name:   Upload Artifact
      uses:   actions/upload-artifact@v2
      with:
        name: build-windows
        path: "${{github.workspace}}/VolumeControl*.zip"
        
    - name: 'Create Release'
      uses: softprops/action-gh-release@v1
      with:
        draft:    true
        files:    |
                  ${{github.workspace}}/*.zip
