name: Generate Release

# Trigger on SEMVER-format tag push event
on:
  push:
    tags: '*.*.*'
  workflow_dispatch:

# Configuration Type
env:
  BUILD_TYPE: 'Release'

jobs:
  # This job is required because C# is assholes and dotnet publish refuses to use the version number set by the SetVersion.ps1 script.
  update-version-number:
    runs-on:  windows-2022
    
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth:  0
        
      - name:   Run SetVersion.ps1
        run:    |
                cd ${{github.workspace}}\VolumeControl
                ..\SetVersion.ps1
        shell:  |
                pwsh -noninteractive -command "try {{ $ErrorActionPreference='Stop'; . '{0}' }} catch {{ Write-Error ""FAILED: $_""; throw; }} if ((Test-Path -LiteralPath variable:\LASTEXITCODE)) {{ exit $LASTEXITCODE }}"
        
      - name:   Push Changes
        run:    |
                cd ${{github.workspace}}
                git config user.name github-actions
                git config user.email github-actions@github.com
                git add -A
                git commit -m "Update .csproj Version Numbers"
                git push

  build-release:
    needs:    update-version-number
    runs-on:  windows-2022
    env:
      DOTNET_CLI_TELEMETRY_OPTOUT: true

    steps:
    - uses: actions/checkout@v2
      with:
        fetch-depth:  0
    - uses: actions/setup-dotnet@main
      with:
        dotnet-version: 6.0.x

    - name:   Get Tag Version
      id:     get_version
      run:    |
              cd ${{github.workspace}}
              $TAG=$(git describe --tags --abbrev=0)
              echo ::set-output name=VERSION::$TAG
              if ("$TAG" -like "*pr*") { echo ::set-output name=PRERELEASE::true } else { echo ::set-output name=PRERELEASE::false }
      shell:  powershell

    - name: 'Build VolumeControl Binary'
      run:  dotnet publish VolumeControl -c ${{env.BUILD_TYPE}} /p:PublishProfile="VolumeControl/Properties/PublishProfiles/FolderProfile.pubxml"

    - name: 'Build VersionControlCLI Binary'
      run:  dotnet publish VolumeControlCLI -c ${{env.BUILD_TYPE}} /p:PublishProfile="VolumeControlCLI/Properties/PublishProfiles/FolderProfile.pubxml"

    - name:   Create Staging Workspace
      run:    mkdir "${{github.workspace}}/STAGING"

    - name:   Stage Files
      run:    |
              cd "${{github.workspace}}/STAGING"
              foreach($file in $((dir "${{github.workspace}}/publish" -recurse | where {$_.extension -in ".exe",".dll"}).Fullname)){ mv $file ./ }
              Get-ChildItem -Recurse

    - name:   Upload Artifacts
      uses:   actions/upload-artifact@v2
      with:
        name: build-windows
        path: '${{github.workspace}}/STAGING/*'

  create-release:
    needs:    build-release
    runs-on:  ubuntu-latest

    steps:
    - name: Download Artifacts
      uses: actions/download-artifact@v2
      with:
        path:  ${{github.workspace}}

    - run:  ls -lAghR

    - name: 'Create Release'
      uses: softprops/action-gh-release@v1
      with:
        draft:      true
        prerelease: ${{steps.get_version.outputs.PRERELEASE}}
        tag_name:   ${{steps.get_version.outputs.VERSION}}
        fail_on_unmatched_files: true
        files:      |
                    ${{github.workspace}}/build-windows/VolumeControl.exe
                    ${{github.workspace}}/build-windows/VolumeControlCLI.exe
