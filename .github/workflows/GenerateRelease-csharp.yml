name: Windows Build

on:
  push:
    tags: '*.*.*'
  workflow_dispatch:
    inputs:
      tag:
        required: true
        type:     string

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v2
      with:
        fetch-depth:  0

    - name: Install .NET Core
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 6.0.x
        
    - name: Setup Dotnet
      uses: actions/setup-dotnet@main
      
    - name: Publish VolumeControl Release to Directory
      run:  dotnet publish VolumeControl -c Release /p:PublishProfile="VolumeControl/Properties/PublishProfiles/FolderProfile.pubxml"
      
    - name: Publish VolumeControlCLI Release to Directory
      run:  dotnet publish VolumeControl -c Release /p:PublishProfile="VolumeControlCLI/Properties/PublishProfiles/FolderProfile.pubxml"
      
    - name:   Get Release Tag
      id:     get_version
      run:    |
              $TAG=${GITHUB_REF/refs\/tags\//}
              $TAG=$(if("$TAG" -eq "") { echo "${{github.event.inputs.tag}}" } else { echo $TAG })
              echo ::set-output name=TAG::"$TAG"
      shell:  powershell
      
    - name: Upload Artifact
      uses: actions/upload-artifact@v2
      with:
        name: latest-Windows
        path: |
              ${{github.workspace}}/publish/VolumeControl
              ${{github.workspace}}/publish/VolumeControlCLI
        
  create-release:
    needs:   build
    runs-on: ubuntu-latest
    
    steps:
    - name:   'Get Release Tag'
      id:     get_version
      run:    |
              if [ "${{github.event.inputs.tag}}" == "" ]; then TAG="${GITHUB_REF/refs\/tags\//}"; else TAG="${{github.event.inputs.tag}}" ; fi
              echo ::set-output name=VERSION::$TAG
              echo ::set-output name=NAME::"Release $TAG"
      shell:  bash
      
      # Change working directory to workspace
    - run:  cd ${{github.workspace}}
      
    - name: Download Build Artifact
      uses: actions/download-artifact@v2
      with:
        name: latest-Windows
        # Creates Directories:
        #   ${{github.workspace}}/VolumeControl
        #   ${{github.workspace}}/VolumeControlCLI
      
    - name:   'Stage Files'
      run:    |
              rm "${{github.workspace}}/VolumeControl*/*.pdb"
              zip -T9 "VolumeControl-${{steps.get_version.outputs.VERSION}}.zip" "${{github.workspace}}/VolumeControl/*"
              zip -T9 "VolumeControlCLI-${{steps.get_version.outputs.VERSION}}.zip" "${{github.workspace}}/VolumeControlCLI/*"
      shell:  bash

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        draft:                    true
        prerelease:               false
        tag_name:                 ${{ steps.get_version.outputs.VERSION }}
        name:                     ${{ steps.get_version.outputs.NAME }}
        generate_release_notes:   true
        fail_on_unmatched_files:  true
        files:                    ${{github.workspace}}/*.zip
