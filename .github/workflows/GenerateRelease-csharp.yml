name: Windows Build

on:
  push:
    tags: '*.*.*'
  workflow_dispatch:
    inputs:
      tag:
        required: true
        type:     string

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v2
      with:
        fetch-depth: 0

    - name: Install .NET Core
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 6.0.x
        
    - name: Setup Dotnet
      uses: actions/setup-dotnet@main
      
    - name: Publish Release to Directory
      run:  dotnet publish VolumeControl -c Release /p:PublishProfile="VolumeControl/Properties/PublishProfiles/FolderProfile.pubxml"
      
    - name: Stage Files
      run:  |
            cd publish/VolumeControl
            rm *.pdb
            Compress-Archive ./* VolumeControl-${GITHUB_REF/refs\/tags\//}.zip
      
    - name: Upload Artifact
      uses: actions/upload-artifact@v2
      with:
        name: latest-Windows
        path: ${{github.workspace}}/publish/VolumeControl/*.zip
        
  create-release:
    needs:   build
    runs-on: windows-latest
    
    steps:
      - name: Download Build Artifacts
        uses: actions/download-artifact@v2
        
      - name: Get Release Tag
        id:   get_version
        run:  echo ::set-output name=NAME::"Release ${GITHUB_REF/refs\/tags\//}"
        
      - name:   Stage Archives
        run:    |
                cd ${{github.workspace}}
                ls -lAghR
                mv ./*/*.zip ./
        
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          draft:                    true
          prerelease:               false
          tag_name:                 ${GITHUB_REF/refs\/tags\//}
          name:                     ${{steps.get_version.outputs.NAME}}
          generate_release_notes:   true
          fail_on_unmatched_files:  true
          files:                    ${{github.workspace}}/*/*.zip
